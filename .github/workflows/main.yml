name: AI Changelog Generator

on:
  push:
    branches:
      - main  # Or your desired branch

jobs:
  summarize-commit:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get Last Commit Diff
        id: diff
        run: |
          git fetch origin
          DIFF=$(git show --no-color HEAD)
          DIFF_CLEANED=$(echo "$DIFF" | head -c 4000 | sed 's/"/\\"/g')
          echo "diff_text=\"$DIFF_CLEANED\"" >> $GITHUB_ENV

      - name: Get AI Summary from OpenAI
        id: ai_summary
        run: |
          RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer ${{ secrets.OPENAI_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"model\": \"gpt-4-o\",
              \"messages\": [
                {\"role\": \"system\", \"content\": \"You are a helpful assistant that summarizes code changes for changelogs.\"},
                {\"role\": \"user\", \"content\": \"Summarize these code changes in a single sentence:\n\n$diff_text\"}
              ]
            }")

          SUMMARY=$(echo "$RESPONSE" | jq -r '.choices[0].message.content' | tr '\n' ' ')
          echo "summary=$SUMMARY" >> $GITHUB_OUTPUT

      - name: Add Summary to Changelog
        run: |
          CHANGELOG_FILE="docs/changelog.md"
          DATE=$(date +"%Y-%m-%d")
          SUMMARY="${{ steps.ai_summary.outputs.summary }}"
          ENTRY="$DATE - $SUMMARY"

          mkdir -p docs
          touch "$CHANGELOG_FILE"

          # Insert entry under ### Added or create it
          if grep -q "^### Added" "$CHANGELOG_FILE"; then
            awk -v line="$ENTRY" '
              /^### Added/ { print; print line; next }
              { print }
            ' "$CHANGELOG_FILE" > tmp && mv tmp "$CHANGELOG_FILE"
          else
            echo -e "\n### Added\n$ENTRY" >> "$CHANGELOG_FILE"
          fi

      - name: Commit and Push Changes
        run: |
          git config --global user.name "AutoDoc Bot"
          git config --global user.email "autodoc@github.com"
          git add docs/changelog.md
          git diff --cached --quiet || git commit -m "chore(changelog): add AI-generated summary with date"
          git push
