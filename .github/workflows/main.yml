name: AI Changelog Generator

on:
  push:
    branches:
      - main

jobs:
  summarize-commit:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get AI Summary of Last Commit
        id: ai_summary
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          DATE=$(date +"%Y-%m-%d")
          DIFF=$(git show --no-color HEAD | head -c 4000)

          REQUEST=$(jq -n --arg diff "$DIFF" '{
            model: "gpt-4.1",
            messages: [
              {role: "system", content: "You are a helpful assistant that summarizes code changes for changelogs."},
              {role: "user", content: "Summarize these code changes in a single sentence:\n\n\($diff)"}
            ]
          }')

          RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$REQUEST")

          # SUMMARY=$(echo "$RESPONSE" | jq -r '.choices[0].message.content' | tr '\n' ' ')
          echo "🔍 OpenAI API Response:"
          echo "$RESPONSE"

          SUMMARY=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // empty' | tr '\n' ' ')
          echo "📝 Extracted summary: $SUMMARY"
          echo "DATE=$DATE" >> $GITHUB_ENV
          echo "SUMMARY=$SUMMARY" >> $GITHUB_ENV

      - name: Update Changelog
        run: |
          CHANGELOG_FILE="docs/changelog.md"
          mkdir -p docs
          touch "$CHANGELOG_FILE"

          ENTRY="$DATE - $SUMMARY"

          if grep -q "^### Added" "$CHANGELOG_FILE"; then
            awk -v line="$ENTRY" '
              /^### Added/ { print; print line; next }
              { print }
            ' "$CHANGELOG_FILE" > tmp && mv tmp "$CHANGELOG_FILE"
          else
            echo -e "\n### Added\n$ENTRY" >> "$CHANGELOG_FILE"
          fi

      - name: Commit and Push
        run: |
          git config --global user.name "DocuNinja Bot"
          git config --global user.email "docuninja@github.com"
          git add docs/changelog.md
          git diff --cached --quiet || git commit -m "chore(changelog): AI-generated summary"
          git push
