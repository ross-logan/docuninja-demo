name: Auto-Changelog from Commit Message

on:
  push:
    branches:
      - main  # or 'qa', etc.

jobs:
  update-changelog:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get Last Commit Message
        id: get_commit
        run: |
          echo "message=$(git log -1 --pretty=%s)" >> $GITHUB_OUTPUT

      - name: Insert Commit Message into Changelog
        run: |
          COMMIT_MSG="${{ steps.get_commit.outputs.message }}"
          CHANGELOG_FILE="docs/changelog.md"

          # Create changelog file if it doesn't exist
          mkdir -p docs
          touch "$CHANGELOG_FILE"

          # Insert under '### Added' or add section if missing
          if grep -q "^### Added" "$CHANGELOG_FILE"; then
            awk -v line="- $COMMIT_MSG" '
              /^### Added/ { print; print line; next }
              { print }
            ' "$CHANGELOG_FILE" > tmp && mv tmp "$CHANGELOG_FILE"
          else
            echo -e "\n### Added\n- $COMMIT_MSG" >> "$CHANGELOG_FILE"
          fi

      - name: Commit and Push Changes
        run: |
          git config --global user.name "DocuNinja"
          git config --global user.email "docuninja@github.com"
          git add docs/changelog.md
          git diff --cached --quiet || git commit -m "chore(changelog): add commit message to changelog"
          git push
